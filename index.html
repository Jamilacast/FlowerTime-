 <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸŒ¸ FlowerTime â€” Organiza tu tiempo</title>
  <style>
    :root{--bg:#fff6fb;--accent:#d6336c;--muted:#6b7280}
    html,body{height:100%;margin:0;font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{background:linear-gradient(135deg,#fff7fb 0%, #f0fff6 100%);padding:24px}
    .container{max-width:1100px;margin:0 auto}
    h1{color:var(--accent);font-size:28px;margin:0 0 18px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:white;border-radius:16px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .col-5{grid-column:span 5}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    .col-7{grid-column:span 7}
    .title-sm{font-weight:600;margin-bottom:8px}
    button{cursor:pointer}
    .btn-primary{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:8px}
    .btn-muted{background:white;border:1px solid #e5e7eb;padding:8px 12px;border-radius:8px}
    input[type="text"],input[type="date"],textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e6e6;margin-bottom:8px}
    .pomodoro-time{font-family:monospace;font-size:40px;text-align:center;margin:12px 0}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day{min-height:72px;padding:8px;border-radius:8px;border:1px solid #eee;background:#fff;cursor:pointer}
    .date{font-size:12px;color:var(--muted);font-weight:600}
    .task-line{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:#fbfbfc;margin-bottom:8px}
    .muted{color:var(--muted);font-size:13px}
    @media (max-width:900px){
      .grid{grid-template-columns:1fr}
      .col-5,.col-4,.col-3,.col-7{grid-column:1}
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
      <h1 id="mainTitle">ğŸŒ¸ FlowerTime â€” Organiza tu tiempo</h1>
      <div style="display:flex;gap:12px;align-items:center;">
        <button id="userBtn" title="Usuario" style="background:none;border:none;font-size:16px;cursor:pointer;outline:none;padding:6px 12px;border-radius:8px;background:#ffe3ef;color:#d6336c;font-weight:600;">ğŸ‘¤</button>
        <button id="themeConfigBtn" title="Cambiar temÃ¡tica" style="background:none;border:none;font-size:26px;cursor:pointer;outline:none;">âš™ï¸</button>
      </div>
    </div>
    <div id="themeSelector" style="display:none;position:absolute;top:54px;right:32px;background:#fff6fb;border:2px solid #d6336c;border-radius:14px;box-shadow:0 4px 16px #d6336c22;padding:18px 22px;z-index:2000;">
      <div style="font-weight:bold;color:#d6336c;font-size:17px;margin-bottom:10px;">Elige una temÃ¡tica:</div>
      <button class="theme-btn" data-theme="flores" style="display:block;width:100%;margin-bottom:8px;font-size:17px;">ğŸŒ¸ Flores</button>
      <button class="theme-btn" data-theme="mar" style="display:block;width:100%;margin-bottom:8px;font-size:17px;">ğŸŒŠ Mar y ocÃ©ano</button>
      <button class="theme-btn" data-theme="luna" style="display:block;width:100%;font-size:17px;">ğŸŒ™ Lunas y constelaciones</button>
    </div>
  <script>
  // ====== SISTEMA DE USUARIOS ======
  class UserSystem {
    static getCurrentUser() {
      return localStorage.getItem('flowertime_currentUser');
    }
    
    static setCurrentUser(username) {
      localStorage.setItem('flowertime_currentUser', username);
    }
    
    static getAllUsers() {
      return JSON.parse(localStorage.getItem('flowertime_users') || '{}');
    }
    
    static userExists(username) {
      return this.getAllUsers().hasOwnProperty(username);
    }
    
    static registerUser(username) {
      const users = this.getAllUsers();
      if(this.userExists(username)) return false;
      users[username] = {
        createdAt: new Date().toISOString(),
        theme: 'flores'
      };
      localStorage.setItem('flowertime_users', JSON.stringify(users));
      this.setCurrentUser(username);
      return true;
    }
    
    static loginUser(username) {
      if(!this.userExists(username)) return false;
      this.setCurrentUser(username);
      return true;
    }
    
    static logoutUser() {
      localStorage.removeItem('flowertime_currentUser');
    }
    
    static getUserKey(key) {
      const user = this.getCurrentUser();
      return user ? `user_${user}_${key}` : key;
    }
  }
  
  function showAuthForm() {
    if(document.getElementById('authForm')) return;
    
    const form = document.createElement('div');
    form.id = 'authForm';
    form.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
    
    form.innerHTML = `
      <div style="background:#fff6fb;border:2px solid #d6336c;border-radius:16px;padding:32px;max-width:400px;box-shadow:0 10px 40px rgba(0,0,0,0.2);">
        <div style="font-weight:bold;color:#d6336c;font-size:24px;margin-bottom:20px;text-align:center;">ğŸŒ¸ FlowerTime</div>
        <div style="margin-bottom:16px;">
          <div style="font-weight:600;color:#d6336c;margin-bottom:8px;">Nombre de usuario</div>
          <input id="authUsername" type="text" placeholder="Tu nombre..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #d6336c;box-sizing:border-box;font-size:14px;">
          <div style="font-size:12px;color:#6b7280;margin-top:6px;">Ej: MarÃ­a, Juan, etc.</div>
        </div>
        <div style="margin-bottom:20px;display:flex;gap:8px;">
          <button id="authRegister" class="btn-primary" style="flex:1;padding:10px;">Registrarse</button>
          <button id="authLogin" class="btn-muted" style="flex:1;padding:10px;border:1px solid #d6336c;color:#d6336c;font-weight:600;">Entrar</button>
        </div>
        <div id="authMessage" style="font-size:12px;color:#d6336c;text-align:center;min-height:20px;"></div>
      </div>
    `;
    
    document.body.appendChild(form);
    const input = document.getElementById('authUsername');
    input.focus();
    
    document.getElementById('authRegister').onclick = function() {
      const username = input.value.trim();
      if(!username) { document.getElementById('authMessage').innerText = 'Por favor ingresa un nombre'; return; }
      if(UserSystem.userExists(username)) {
        document.getElementById('authMessage').innerText = 'Nombre en uso, por favor elige otro';
        input.focus();
        return;
      }
      UserSystem.registerUser(username);
      form.remove();
      location.reload();
    };
    
    document.getElementById('authLogin').onclick = function() {
      const username = input.value.trim();
      if(!username) { document.getElementById('authMessage').innerText = 'Por favor ingresa un nombre'; return; }
      if(!UserSystem.userExists(username)) {
        document.getElementById('authMessage').innerText = 'Usuario no encontrado, regÃ­strate'; 
        input.focus();
        return;
      }
      UserSystem.loginUser(username);
      form.remove();
      location.reload();
    };
    
    input.onkeypress = function(e) {
      if(e.key === 'Enter') document.getElementById('authRegister').click();
    };
  }
  
  function initAuth() {
    if(!UserSystem.getCurrentUser()) {
      showAuthForm();
      return false;
    }
    return true;
  }

  // TemÃ¡ticas disponibles
  const THEMES = {
    flores: {
      '--bg':'#fff6fb', '--accent':'#d6336c', '--muted':'#6b7280',
      title:'ğŸŒ¸ FlowerTime â€” Organiza tu tiempo',
      nav1:'ğŸŒ»', nav2:'ğŸŒ¸',
  bgGradient:'linear-gradient(135deg,#fff7fb 0%, #f0fff6 100%)',
  bgImage: `url('data:image/svg+xml;utf8,<svg width="600" height="600" xmlns="http://www.w3.org/2000/svg"><text x="40" y="120" font-size="90" opacity=".13">ğŸŒ¸ğŸŒ·ğŸŒº</text><text x="300" y="500" font-size="110" opacity=".10">ğŸŒ»ğŸŒ¼</text></svg>')`,
      streakBg:'#ffe3ef', streakBorder:'#d6336c', streakText:'#d6336c', monthColor:'#d6336c',
      pomodoroWorkIcon:'ğŸŒ»', pomodoroBreakIcon:'ğŸŒ¸', pomodoroWorkGradient:'linear-gradient(135deg,#ffe3ef,#fff6fb)', pomodoroBreakGradient:'linear-gradient(135deg,#fff0f5,#ffe6f0)', pomodoroWorkColor:'#d6336c', pomodoroBreakColor:'#d6336c'
    },
    mar: {
      '--bg':'#e0f7fa', '--accent':'#0077b6', '--muted':'#006080',
      title:'ğŸŒŠ OceanTime â€” Organiza tu tiempo',
      nav1:'ğŸš', nav2:'ğŸŒŠ',
  bgGradient:'linear-gradient(135deg,#e0f7fa 0%, #b2ebf2 100%)',
  bgImage: `url('data:image/svg+xml;utf8,<svg width="600" height="600" xmlns="http://www.w3.org/2000/svg"><text x="40" y="120" font-size="90" opacity=".13">ğŸŸğŸ ğŸ¬</text><text x="300" y="500" font-size="110" opacity=".10">ğŸ³ğŸ‹</text></svg>')`,
      streakBg:'#b2ebf2', streakBorder:'#0077b6', streakText:'#0077b6', monthColor:'#0077b6',
      pomodoroWorkIcon:'ğŸ ', pomodoroBreakIcon:'ğŸŒŠ', pomodoroWorkGradient:'linear-gradient(135deg,#80deea,#b2ebf2)', pomodoroBreakGradient:'linear-gradient(135deg,#b3e5fc,#e0f2f1)', pomodoroWorkColor:'#0077b6', pomodoroBreakColor:'#0077b6'
    },
    luna: {
      '--bg':'#f3f0ff', '--accent':'#5f3dc4', '--muted':'#6c757d',
      title:'ğŸŒ™ MoonTime â€” Organiza tu tiempo',
      nav1:'ğŸŒ ', nav2:'ğŸŒ™',
  bgGradient:'linear-gradient(135deg,#f3f0ff 0%, #dee2ff 100%)',
  bgImage: `url('data:image/svg+xml;utf8,<svg width="600" height="600" xmlns="http://www.w3.org/2000/svg"><text x="40" y="120" font-size="90" opacity=".13">ğŸŒ™âœ¨</text><text x="300" y="500" font-size="110" opacity=".10">ğŸŒŸğŸ”­</text></svg>')`,
      streakBg:'#e5dbff', streakBorder:'#5f3dc4', streakText:'#5f3dc4', monthColor:'#5f3dc4',
      pomodoroWorkIcon:'â­', pomodoroBreakIcon:'ğŸŒ™', pomodoroWorkGradient:'linear-gradient(135deg,#ce93d8,#e1bee7)', pomodoroBreakGradient:'linear-gradient(135deg,#e1bee7,#f3e5f5)', pomodoroWorkColor:'#5f3dc4', pomodoroBreakColor:'#5f3dc4'
    }
  };

  document.addEventListener('DOMContentLoaded', function(){

  function applyTheme(themeKey) {
    const theme = THEMES[themeKey] || THEMES.flores;
    for(const v in theme) {
      if(v.startsWith('--')) document.documentElement.style.setProperty(v, theme[v]);
    }
    document.body.style.background = theme.bgGradient;
    document.body.style.backgroundImage = theme.bgImage;
    document.body.style.backgroundRepeat = 'no-repeat';
    document.body.style.backgroundPosition = 'bottom right';
    document.body.style.backgroundSize = 'contain';
    // Fondo decorativo tambiÃ©n en el calendario
    const calCard = document.querySelector('.card.col-12');
    if(calCard) {
      calCard.style.background = theme.bgGradient;
      calCard.style.backgroundImage = theme.bgImage;
      calCard.style.backgroundRepeat = 'no-repeat';
      calCard.style.backgroundPosition = 'bottom right';
      calCard.style.backgroundSize = 'contain';
    }
    document.getElementById('mainTitle').innerText = theme.title;
    // Cambiar Ã­conos de navegaciÃ³n
    document.getElementById('prevYear').innerText = theme.nav1;
    document.getElementById('nextYear').innerText = theme.nav1;
    document.getElementById('prevMonth').innerText = theme.nav2;
    document.getElementById('nextMonth').innerText = theme.nav2;
    // Cambiar color del mes
    const label = document.getElementById('calendarLabel');
    if(label) label.style.color = theme.monthColor;
    // Cambiar color de la racha
    const streak = document.getElementById('streakContainer');
    if(streak) {
      const box = streak.querySelector('div');
      if(box) {
        box.style.background = theme.streakBg;
        box.style.borderColor = theme.streakBorder;
        box.style.color = theme.streakText;
        // Cambiar color de los textos internos
        const strongs = box.querySelectorAll('div');
        strongs.forEach(el=>el.style.color=theme.streakText);
      }
    }
    // Actualizar Pomodoro con el nuevo tema
    updatePomodoroTheme();
    localStorage.setItem(UserSystem.getUserKey('theme'), themeKey);
  }

  // Mostrar/ocultar selector
  document.getElementById('themeConfigBtn').onclick = function(e) {
    e.stopPropagation();
    const sel = document.getElementById('themeSelector');
    sel.style.display = sel.style.display==='block' ? 'none' : 'block';
  };
  
  // BotÃ³n de usuario
  document.getElementById('userBtn').onclick = function(e) {
    e.stopPropagation();
    const menu = document.getElementById('userMenu');
    // Toggle simple: si existe lo removemos, si no, lo creamos
    if(menu) {
      menu.remove();
    } else {
      showUserMenu();
    }
  };
  
  function showUserMenu() {
    let menu = document.getElementById('userMenu');
    if(menu) menu.remove();
    
    const user = UserSystem.getCurrentUser();
    menu = document.createElement('div');
    menu.id = 'userMenu';
    menu.style.cssText = 'position:absolute;top:54px;right:180px;background:#fff6fb;border:2px solid #d6336c;border-radius:12px;box-shadow:0 4px 16px #d6336c22;padding:14px;z-index:2000;min-width:200px;';
    menu.innerHTML = `
      <div style="font-weight:600;color:#d6336c;font-size:14px;margin-bottom:10px;text-align:center;padding:8px;background:#ffe3ef;border-radius:8px;">ğŸ‘¤ ${user}</div>
      <button id="logoutBtn" style="display:block;width:100%;padding:10px;margin-top:8px;background:#d6336c;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;">Cerrar sesiÃ³n</button>
    `;
    document.querySelector('[style*="display:flex"][style*="align-items:center"]').appendChild(menu);
    menu.style.display = 'block';
    // Asignar el handler programÃ¡ticamente (evita problemas con scope de funciones inline)
    const lb = menu.querySelector('#logoutBtn');
    if(lb) lb.onclick = logoutUser;
  }
  
  function logoutUser() {
    if(confirm('Â¿EstÃ¡s seguro que quieres cerrar sesiÃ³n?')) {
      UserSystem.logoutUser();
      location.reload();
    }
  }
  // Exponer globalmente por si hay referencias inline
  window.logoutUser = logoutUser;
  
  // Cerrar selector al hacer clic fuera
  document.addEventListener('click', function(e){
    const sel = document.getElementById('themeSelector');
    const menu = document.getElementById('userMenu');
    const btn = document.getElementById('themeConfigBtn');
    const userBtn = document.getElementById('userBtn');
    const moodToggle = document.getElementById('moodToggleBtn');
    const moodPicker = document.getElementById('moodPicker');

    if(sel && sel.style.display==='block' && !sel.contains(e.target) && e.target!==btn) sel.style.display='none';
    if(menu && !menu.contains(e.target) && e.target!==userBtn && e.target !== userBtn.parentElement) menu.remove();
    if(moodPicker && moodPicker.style.display==='block' && !moodPicker.contains(e.target) && e.target!==moodToggle) moodPicker.style.display='none';
  });
  // SelecciÃ³n de tema
  document.querySelectorAll('.theme-btn').forEach(btn=>{
    btn.onclick = function(e){ e.stopPropagation(); applyTheme(btn.dataset.theme); document.getElementById('themeSelector').style.display='none'; };
  });
  // Aplicar tema guardado
  const savedTheme = localStorage.getItem(UserSystem.getUserKey('theme')) || 'flores';
  setTimeout(()=>applyTheme(savedTheme), 0);
  });
  </script>
  
  <!-- El resto del script ya estÃ¡ incluido en el HTML completo (extraÃ­do de flowertime.html) -->

    <div class="grid">
      <!-- Lista de tareas -->
      <div class="card col-4">
  <div id="streakContainer" style="margin-bottom:18px;"></div>
        <div class="title-sm">âœ… Lista de pendientes</div>
        <input type="text" id="taskInput" placeholder="Nueva tarea..."/>
        <button class="btn-primary" onclick="addTask()">Agregar</button>
        <div id="taskList"></div>
      </div>

      <!-- Pomodoro -->
      <div class="card col-4">
        <div class="title-sm">â³ Pomodoro</div>
        <div id="currentTime" style="text-align:center;color:var(--muted);font-size:13px;margin-bottom:8px;font-weight:600;">--:--</div>
        <div id="pomodoroCircle" style="width:140px;height:140px;margin:16px auto;border-radius:50%;background:transparent;border:3px solid #d6336c;display:flex;align-items:center;justify-content:center;position:relative;box-shadow:0 4px 16px #d6336c22;transition:all 0.3s ease;">
          <div style="text-align:center;width:100%;">
              <div id="pomodoro" class="pomodoro-time" style="font-size:28px;margin:0;font-weight:bold;">25:00</div>
            <div id="pomodoroPhase" style="font-size:11px;color:#d6336c;font-weight:600;margin-top:4px;letter-spacing:0.5px;">TRABAJO</div>
          </div>
        </div>
        <div style="margin-bottom:10px;display:flex;gap:6px;align-items:center;justify-content:center;">
          <button class="btn-primary" onclick="startPomodoro()" style="padding:6px 12px;font-size:13px;flex:1;">Iniciar</button>
          <button class="btn-muted" onclick="pausePomodoro()" style="padding:6px 12px;font-size:13px;flex:1;display:none;" id="pauseBtn">Pausar</button>
          <button class="btn-muted" onclick="resetPomodoro()" style="padding:6px 12px;font-size:13px;flex:1;">Reiniciar</button>
        </div>
        <button onclick="showPomodoroSettings()" style="background:#f0f0f0;border:1px solid #ddd;padding:6px 12px;border-radius:8px;width:100%;font-size:12px;cursor:pointer;color:#666;font-weight:600;">âš™ï¸ Personalizar tiempo</button>
        <!-- Selector de estado de Ã¡nimo (oculto por defecto) -->
        <!-- Selector de estado de Ã¡nimo (oculto por defecto) -->
        <div style="margin-top:10px;">
          <button id="moodToggleBtn" style="width:100%;background:#fff;border:1px solid #e6e6e6;padding:8px;border-radius:8px;cursor:pointer;font-size:14px;">ğŸ™‚ Â¿CÃ³mo te sientes? (Seleccionar)</button>
          <div id="moodPicker" style="display:none;margin-top:8px;padding:8px 6px;border-radius:8px;border:1px solid #e6e6e6;background:#fbfbfc;">
          <div style="font-size:13px;color:#6b7280;margin-bottom:6px;font-weight:600;text-align:center;">Â¿CÃ³mo te sientes ahora?</div>
          <div id="moodButtons" style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
            <button class="mood-btn" data-mood="very_happy" style="font-size:20px;padding:6px 8px;border-radius:8px;background:white;border:1px solid #eee;">ğŸ˜„</button>
            <button class="mood-btn" data-mood="happy" style="font-size:20px;padding:6px 8px;border-radius:8px;background:white;border:1px solid #eee;">ğŸ™‚</button>
            <button class="mood-btn" data-mood="calm" style="font-size:20px;padding:6px 8px;border-radius:8px;background:white;border:1px solid #eee;">ğŸ˜Œ</button>
            <button class="mood-btn" data-mood="meh" style="font-size:20px;padding:6px 8px;border-radius:8px;background:white;border:1px solid #eee;">ğŸ˜•</button>
            <button class="mood-btn" data-mood="sad" style="font-size:20px;padding:6px 8px;border-radius:8px;background:white;border:1px solid #eee;">ğŸ˜”</button>
            <button class="mood-btn" data-mood="love" style="font-size:20px;padding:6px 8px;border-radius:8px;background:white;border:1px solid #eee;">ğŸ˜</button>
            <button class="mood-btn" data-mood="tired" style="font-size:20px;padding:6px 8px;border-radius:8px;background:white;border:1px solid #eee;">ğŸ˜´</button>
            <button class="mood-btn" data-mood="angry" style="font-size:20px;padding:6px 8px;border-radius:8px;background:white;border:1px solid #eee;">ğŸ˜¤</button>
          </div>
          <div id="moodSelected" style="margin-top:8px;text-align:center;color:#6b7280;font-size:13px;"></div>
          </div>
        </div>
        <div id="pomodoroSettings" style="display:none;margin-top:10px;padding:10px;background:#fbfbfc;border-radius:8px;border:1px solid #e6e6e6;">
          <div style="margin-bottom:8px;">
            <label style="font-size:12px;font-weight:600;color:#666;">Trabajo (minutos)</label>
            <input id="workMinutes" type="number" min="1" max="60" value="25" style="width:100%;padding:6px;border-radius:6px;border:1px solid #e6e6e6;box-sizing:border-box;">
          </div>
          <div style="margin-bottom:10px;">
            <label style="font-size:12px;font-weight:600;color:#666;">Descanso (minutos)</label>
            <input id="breakMinutes" type="number" min="1" max="30" value="5" style="width:100%;padding:6px;border-radius:6px;border:1px solid #e6e6e6;box-sizing:border-box;">
          </div>
          <div style="display:flex;gap:6px;">
            <button onclick="savePomodoroSettings()" class="btn-primary" style="flex:1;font-size:12px;padding:6px;">Guardar</button>
            <button onclick="closePomodoroSettings()" class="btn-muted" style="flex:1;font-size:12px;padding:6px;border:1px solid #ddd;">Cancelar</button>
          </div>
        </div>
      </div>

      <!-- Reto flor -->
      <div class="card col-4">
        <div class="title-sm">ğŸŒ± Reto flor</div>
        <textarea id="challengeInput" placeholder="Describe tu objetivo o meta..." rows="3"></textarea>
        <input type="date" id="challengeDate" style="margin-top:8px" />
        <button class="btn-primary" onclick="addChallenge()">AÃ±adir reto</button>
        <div id="challengeList" style="margin-top:10px;"></div>
      </div>

      <!-- Calendario -->
      <div class="card col-12" style="margin-top:20px;grid-column:span 12;">
        <div class="title-sm">ğŸ“… Calendario</div>
        <div style="display:flex;align-items:center;justify-content:center;margin-bottom:10px;gap:10px;">
          <button id="prevYear" class="btn-flower-nav" title="AÃ±o anterior">ğŸŒ»</button>
          <button id="prevMonth" class="btn-flower-nav" title="Mes anterior">ğŸŒ¸</button>
          <span id="calendarLabel" style="font-weight:bold;font-size:18px;color:#d6336c;min-width:120px;text-align:center;display:inline-block;flex:1;"></span>
          <button id="nextMonth" class="btn-flower-nav" title="Mes siguiente">ğŸŒ¸</button>
          <button id="nextYear" class="btn-flower-nav" title="AÃ±o siguiente">ğŸŒ»</button>
        </div>
        <div class="calendar" id="calendar"></div>
      </div>
    </div>

  <script>
    // ====== Lista de tareas ======
    function addTask(){
      const input = document.getElementById('taskInput');
      const text = input.value.trim();
      if(!text) return;
      const taskList = document.getElementById('taskList');
      const div = document.createElement('div');
      div.className = 'task-line';
      // BotÃ³n de cumplida (âœ…) y eliminar (âŒ)
      div.innerHTML = '<span>'+text+'</span>'+
        '<div>'+
        '<button class="btn-streak" onclick="completeTask(this)" title="Marcar como cumplida">âœ…</button> '+
        '<button onclick="this.parentNode.parentNode.remove()">âŒ</button>'+
        '</div>';
      taskList.appendChild(div);
      input.value = '';
      // if the streak was already registered today, disable the new task's streak button
      checkStreakButtons();
    }
    // Marcar tarea como cumplida y actualizar racha
    function completeTask(btn) {
      // Solo permitir una vez por dÃ­a
      const key = UserSystem.getUserKey('streak_lastDay');
      const today = getTodayStr();
      if (localStorage.getItem(key) === today) {
        // Ya registrado: desactivar todos los botones para evitar intentos adicionales (sin cambiar su texto)
        document.querySelectorAll('.btn-streak').forEach(b => { b.disabled = true; });
        alert('Â¡Ya registraste tu tarea cumplida hoy!');
        return;
      }
      // Marcar solo el botÃ³n actual y actualizar la racha una sola vez
      btn.disabled = true;
      btn.innerText = 'ğŸ‰';
      updateStreak();
      // Tras actualizar la racha, desactivar todos los botones para que nadie mÃ¡s pueda registrar hoy
      document.querySelectorAll('.btn-streak').forEach(b => { b.disabled = true; });
    }

    // Comprueba si la racha ya estÃ¡ registrada hoy y desactiva los botones de racha sin alterar su texto
    function checkStreakButtons(){
      const key = UserSystem.getUserKey('streak_lastDay');
      const today = getTodayStr();
      if(localStorage.getItem(key) === today){
        document.querySelectorAll('.btn-streak').forEach(b => { b.disabled = true; });
      }
    }
    // ====== Racha de tareas ======
    function getTodayStr() {
      const today = new Date();
      return today.getFullYear() + '-' + (today.getMonth()+1).toString().padStart(2,'0') + '-' + today.getDate().toString().padStart(2,'0');
    }

    function updateStreak() {
      const today = getTodayStr();
      let lastDay = localStorage.getItem(UserSystem.getUserKey('streak_lastDay'));
      let streak = parseInt(localStorage.getItem(UserSystem.getUserKey('streak_count')) || '0');
      if (lastDay === today) {
        // Ya se registrÃ³ hoy, no aumentar racha
        showStreak(streak);
        return;
      }
      if (lastDay) {
        const last = new Date(lastDay);
        const now = new Date(today);
        const diff = (now - last) / (1000*60*60*24);
        if (diff === 1) {
          streak += 1;
        } else {
          streak = 1;
        }
      } else {
        streak = 1;
      }
      localStorage.setItem(UserSystem.getUserKey('streak_lastDay'), today);
      localStorage.setItem(UserSystem.getUserKey('streak_count'), streak);
      showStreak(streak);
    }

    function showStreak(streak) {
      const theme = THEMES[localStorage.getItem(UserSystem.getUserKey('theme')) || 'flores'];
      const el = document.getElementById('streakContainer');
      const mood = localStorage.getItem(UserSystem.getUserKey('mood')) || 'neutral';
      const phrase = getEncouragingPhrase(mood);
      el.innerHTML = `
        <div style="background: ${theme.streakBg}; border-radius: 14px; padding: 18px; box-shadow: 0 2px 8px ${theme.streakBorder}22; text-align: center; border: 2px solid ${theme.streakBorder}; max-width: 320px; margin: 0 auto 10px auto; color:${theme.streakText};">
          <div style="font-size: 18px; font-weight: bold; color: ${theme.streakText}; margin-bottom: 6px;">Racha</div>
          <div style="font-size: 32px; font-weight: bold; color: ${theme.streakText};">ğŸ”¥ ${streak} dÃ­a${streak === 1 ? '' : 's'}</div>
          <div id="streakPhrase" style="color:${theme.streakText}; font-size:14px; margin-top:10px; font-weight:600;">${phrase}</div>
        </div>
      `;
    }

    // Generador de frases de Ã¡nimo combinatorio (muchas combinaciones posibles)
    function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    const phraseParts = {
      very_happy: {
        open: ['Â¡Excelente!','Â¡IncreÃ­ble!','Â¡Brillante!','Â¡Maravilloso!','Â¡FantÃ¡stico!'],
        mid: ['tu energÃ­a contagia.','estÃ¡s en racha.','sigue asÃ­, campeÃ³n.','todo fluye a tu favor.','tu esfuerzo brilla.'],
        end: ['ğŸŒŸ','ğŸ’«','ğŸ‰','ğŸŒˆ','ğŸ†']
      },
      happy: {
        open: ['Â¡Genial!','Â¡Buen trabajo!','Â¡Muy bien!','Â¡Perfecto!','Â¡Bien hecho!'],
        mid: ['avanzas con paso firme.','cada paso cuenta.','tu constancia vale oro.','sigue construyendo tus hÃ¡bitos.','estÃ¡s haciendo progreso.'],
        end: ['ğŸ™‚','ğŸŒ¼','ğŸ‘','âœ¨','ğŸŒŸ']
      },
      calm: {
        open: ['Respira hondo.','Tranquilo/a, todo bien.','Pausa y sonrÃ­e.','Serenidad ante todo.'],
        mid: ['tu ritmo es sano.','has hecho lo importante hoy.','pequeÃ±os pasos, gran cambio.','cuida tu calma y sigue.'],
        end: ['ğŸŒ¿','â˜ï¸','ğŸŒ™','ğŸƒ']
      },
      meh: {
        open: ['No pasa nada.','EstÃ¡ bien sentirlo.','Un paso a la vez.'],
        mid: ['maÃ±ana serÃ¡ mejor.','hoy diste lo que pudiste.','permÃ­tete descansar si hace falta.'],
        end: ['ğŸŒ¤ï¸','ğŸ¤','ğŸŒ±']
      },
      sad: {
        open: ['Lo siento.','Te acompaÃ±o.','AquÃ­ estÃ¡s haciendo lo mejor.'],
        mid: ['tu valor estÃ¡ intacto.','cada intento suma.','no estÃ¡s solo/a en esto.'],
        end: ['ğŸ’œ','ğŸ¤—','ğŸŒ·']
      },
      love: {
        open: ['QuÃ© bonito.','Â¡Genial esa energÃ­a!','Amor propio ante todo.'],
        mid: ['tu entusiasmo inspira.','sigue cuidÃ¡ndote asÃ­.','ese Ã¡nimo te empuja adelante.'],
        end: ['â¤ï¸','ğŸŒ¹','âœ¨']
      },
      tired: {
        open: ['TÃ³mate un respiro.','Descansa un poco.','Recarga pilas.'],
        mid: ['has trabajado duro hoy.','permÃ­tete una pausa breve.','maÃ±ana volverÃ¡s con fuerza.'],
        end: ['ğŸ˜´','â˜•','ğŸ›Œ']
      },
      angry: {
        open: ['Lo entiendo.','Respira.','Canaliza esa fuerza.'],
        mid: ['convierte la rabia en impulso.','un paso calmado cambia la direcciÃ³n.','haz algo que te relaje ahora.'],
        end: ['ğŸ”¥','ğŸ§˜','âš¡']
      },
      neutral: {
        open: ['Â¡Buen dÃ­a!','Sigue adelante.','Hoy es una nueva oportunidad.'],
        mid: ['pequeÃ±os avances cuentan.','cada dÃ­a suma.','mantÃ©n tu constancia.'],
        end: ['ğŸ™‚','ğŸŒŸ','ğŸ’ª']
      }
    };

    function getEncouragingPhrase(mood){
      const p = phraseParts[mood] || phraseParts['neutral'];
      // Evitar repetir la misma frase (guardada por usuario)
      const lastKey = UserSystem.getUserKey('last_phrase');
      let attempt = 0;
      let phrase = '';
      do {
        phrase = pickRandom(p.open) + ' ' + pickRandom(p.mid) + ' ' + pickRandom(p.end);
        attempt++;
      } while(attempt < 8 && localStorage.getItem(lastKey) === phrase);
      try{ localStorage.setItem(lastKey, phrase); }catch(e){}
      return phrase;
    }

    function renderMoodPicker(){
      const container = document.getElementById('moodPicker');
      if(!container) return;
      const saved = localStorage.getItem(UserSystem.getUserKey('mood'));
      const selected = document.getElementById('moodSelected');
      if(saved){
        selected.innerText = 'Seleccionado: ' + (function(m){
          const map = {very_happy:'ğŸ˜„',happy:'ğŸ™‚',calm:'ğŸ˜Œ',meh:'ğŸ˜•',sad:'ğŸ˜”',love:'ğŸ˜',tired:'ğŸ˜´',angry:'ğŸ˜¤'};
          return map[m]||'ğŸ™‚';
        })(saved) + ' (Cambiar)';
      } else {
        selected.innerText = 'Elige un emoji para recibir frases de Ã¡nimo personalizadas';
      }
      // asignar handlers a botones
      document.querySelectorAll('#moodPicker .mood-btn').forEach(b=>{
        b.onclick = function(){
          const m = b.dataset.mood;
          localStorage.setItem(UserSystem.getUserKey('mood'), m);
          renderMoodPicker();
          // actualizar racha con nueva frase
          const streakCount = parseInt(localStorage.getItem(UserSystem.getUserKey('streak_count')) || '0');
          showStreak(streakCount);
          // cerrar picker despuÃ©s de seleccionar
          const picker = document.getElementById('moodPicker');
          if(picker) picker.style.display = 'none';
        };
      });
      // toggle button para mostrar/ocultar el picker
      const toggle = document.getElementById('moodToggleBtn');
      if(toggle) toggle.onclick = function(e){ e.stopPropagation(); const p = document.getElementById('moodPicker'); if(p) p.style.display = (p.style.display==='block') ? 'none' : 'block'; };
    }

    // Probar sonido y notificaciÃ³n del sistema
    function requestNotificationPermission(){
      if(!('Notification' in window)) return Promise.resolve('denied');
      return Notification.requestPermission();
    }

    function showSystemNotification(title, body){
      try{
        if('Notification' in window && Notification.permission === 'granted'){
          new Notification(title, {body: body});
        }
      }catch(e){}
    }

    function testSoundAndNotify(){
      // reproducir sonido
      try{ playAlarmSound('bell'); }catch(e){}
      // notificaciÃ³n del sistema
      if('Notification' in window){
        if(Notification.permission === 'granted'){
          showSystemNotification('Alarma de prueba', 'Este es un sonido de prueba.');
        } else if(Notification.permission !== 'denied'){
          requestNotificationPermission().then(p=>{ if(p === 'granted') showSystemNotification('Alarma de prueba','Este es un sonido de prueba.'); });
        }
      }
    }
    // ====== Reto flor (objetivos y metas) ======
    function getChallenges(){
      return JSON.parse(localStorage.getItem(UserSystem.getUserKey('flower_challenges')) || '[]');
    }
    function saveChallenges(arr){
      localStorage.setItem(UserSystem.getUserKey('flower_challenges'), JSON.stringify(arr));
    }
    function addChallenge(){
      const title = document.getElementById('challengeInput').value.trim();
      const date = document.getElementById('challengeDate').value;
      if(!title) { alert('Escribe un objetivo para el reto.'); return; }
      const arr = getChallenges();
      arr.push({title, date, done: false});
      saveChallenges(arr);
      document.getElementById('challengeInput').value = '';
      document.getElementById('challengeDate').value = '';
      renderChallenges();
    }
    function toggleCompleteChallenge(idx){
      const arr = getChallenges();
      if(!arr[idx]) return;
      arr[idx].done = !arr[idx].done;
      saveChallenges(arr);
      renderChallenges();
    }
    function deleteChallenge(idx){
      const arr = getChallenges();
      arr.splice(idx,1);
      saveChallenges(arr);
      renderChallenges();
    }
    function editChallenge(idx){
      const arr = getChallenges();
      const c = arr[idx];
      if(!c) return;
      const newTitle = prompt('Editar objetivo:', c.title);
      if(newTitle === null) return; // cancel
      const newDate = prompt('Editar fecha (YYYY-MM-DD) o dÃ©jalo vacÃ­o:', c.date || '');
      c.title = newTitle.trim() || c.title;
      c.date = newDate === null ? c.date : (newDate.trim()||'');
      saveChallenges(arr);
      renderChallenges();
    }
    function renderChallenges(){
      const list = document.getElementById('challengeList');
      if(!list) return;
      const arr = getChallenges();
      if(arr.length === 0){ list.innerHTML = '<div class="muted">No hay retos aÃºn. AÃ±ade uno ğŸ™‚</div>'; return; }
      let html = '';
      arr.forEach((c, i) => {
        html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;background:${c.done? '#e6ffee':'#fbfbfc'};margin-bottom:8px;">
          <div style="flex:1;margin-right:8px;">
            <div style="font-weight:600;">${c.title}</div>
            ${c.date? `<div class='muted' style='font-size:13px;margin-top:4px;'>Entrega: ${c.date}</div>` : ''}
          </div>
          <div style="display:flex;gap:6px;align-items:center;">
            <button class="btn-primary" style="background:${c.done? '#6b7280': 'var(--accent)'};padding:6px 8px;font-size:14px;" onclick="toggleCompleteChallenge(${i})">${c.done? 'Hecho':'Marcar'}</button>
            <button class="btn-muted" onclick="editChallenge(${i})">âœï¸</button>
            <button class="btn-muted" onclick="deleteChallenge(${i})">ğŸ—‘ï¸</button>
          </div>
        </div>`;
      });
      list.innerHTML = html;
    }
  // Estilos para el botÃ³n de racha
  const style = document.createElement('style');
  style.innerHTML = `.btn-streak { background: #fff6fb; color: #d6336c; border: 1px solid #d6336c; border-radius: 8px; padding: 4px 10px; margin-right: 4px; font-size: 18px; cursor: pointer; transition: background 0.2s; } .btn-streak:disabled { background: #ffe3ef; color: #aaa; border-color: #ffe3ef; cursor: default; }`;
  document.head.appendChild(style);

    // ====== Pomodoro Mejorado ======
    let pomodoroTimer;
    let pomodoroTimeLeft = 25*60;
    let workDuration = 25*60;
    let breakDuration = 5*60;
    let isWorkPhase = true;
    let isPaused = false;
    
    // Reloj en tiempo real
    function updateClock() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2,'0');
      const minutes = String(now.getMinutes()).padStart(2,'0');
      document.getElementById('currentTime').innerText = hours + ':' + minutes;
    }
    
    function updatePomodoroTheme() {
      const currentTheme = localStorage.getItem(UserSystem.getUserKey('theme')) || 'flores';
      const theme = THEMES[currentTheme] || THEMES.flores;
      const circle = document.getElementById('pomodoroCircle');
      const phase = document.getElementById('pomodoroPhase');

      if(!circle || !phase) return;

      if(isWorkPhase) {
        // Usar fondo transparente en el centro y borde/sombra neutros (sin color temÃ¡tico)
        circle.style.background = 'transparent';
        circle.style.borderColor = 'transparent';
        circle.style.boxShadow = '0 4px 16px rgba(0,0,0,0.06)';
        phase.style.color = theme.pomodoroWorkColor;
      } else {
        circle.style.background = 'transparent';
        circle.style.borderColor = 'transparent';
        circle.style.boxShadow = '0 4px 16px rgba(0,0,0,0.06)';
        phase.style.color = theme.pomodoroBreakColor;
      }
    }
    
    function updatePomodoro(){
      const min = String(Math.floor(pomodoroTimeLeft/60)).padStart(2,'0');
      const sec = String(pomodoroTimeLeft%60).padStart(2,'0');
      document.getElementById('pomodoro').innerText = min+':'+sec;
      document.getElementById('pomodoroPhase').innerText = isWorkPhase ? 'TRABAJO' : 'DESCANSO';
      updatePomodoroTheme();
    }
    
    function loadPomodoroSettings() {
      const work = parseInt(localStorage.getItem(UserSystem.getUserKey('pomodoro_work')) || '25');
      const breakTime = parseInt(localStorage.getItem(UserSystem.getUserKey('pomodoro_break')) || '5');
      workDuration = work * 60;
      breakDuration = breakTime * 60;
      if(!pomodoroTimer) {
        pomodoroTimeLeft = workDuration;
        isWorkPhase = true;
      }
      const workInput = document.getElementById('workMinutes');
      const breakInput = document.getElementById('breakMinutes');
      if(workInput) workInput.value = work;
      if(breakInput) breakInput.value = breakTime;
      updatePomodoro();
    }
    
    // Definiciones de control del Pomodoro (implementadas mÃ¡s abajo)
    
    function showPomodoroSettings(){
      loadPomodoroSettings();
      document.getElementById('pomodoroSettings').style.display = 'block';
    }
    
    function closePomodoroSettings(){
      document.getElementById('pomodoroSettings').style.display = 'none';
    }
    
    function savePomodoroSettings(){
      const workInput = document.getElementById('workMinutes');
      const breakInput = document.getElementById('breakMinutes');
      
      if(!workInput || !breakInput) { alert('Error: elementos no encontrados'); return; }
      
      const work = parseInt(workInput.value) || 25;
      const breakTime = parseInt(breakInput.value) || 5;
      
      if(!work || work < 1 || work > 60) { alert('Trabajo: mÃ­nimo 1, mÃ¡ximo 60 minutos'); return; }
      if(!breakTime || breakTime < 1 || breakTime > 30) { alert('Descanso: mÃ­nimo 1, mÃ¡ximo 30 minutos'); return; }
      
      localStorage.setItem(UserSystem.getUserKey('pomodoro_work'), work);
      localStorage.setItem(UserSystem.getUserKey('pomodoro_break'), breakTime);
      
      resetPomodoro();
      loadPomodoroSettings();
      closePomodoroSettings();
      alert('â±ï¸ ConfiguraciÃ³n guardada: ' + work + 'min trabajo / ' + breakTime + 'min descanso');
    }
    
    function playNotificationSound(){
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
      } catch(e) {}
    }
    
    // Animaciones de objetos cayendo removidas (desactivadas)

    // Mostrar racha y retos al cargar
    document.addEventListener('DOMContentLoaded', function() {
      if(!initAuth()) return; // Verificar usuario
      const streak = parseInt(localStorage.getItem(UserSystem.getUserKey('streak_count')) || '0');
      showStreak(streak);
      try{ renderChallenges(); } catch(e){}
      updateClock();
      setInterval(updateClock, 1000);
      loadPomodoroSettings();
      // Render mood picker UI
      try{ renderMoodPicker(); } catch(e){}
      // Nota: los botones de prueba de sonido ahora estÃ¡n junto al selector de sonido en los formularios de tarea
      // Iniciar el monitor de alarmas de tareas
      try{ initTaskAlarms(); } catch(e){}
      // Desactivar botones de racha si ya se registrÃ³ hoy
      checkStreakButtons();
    });

    // ====== Calendario Mejorado ======
    let currentMonth = (new Date()).getMonth();
    let currentYear = (new Date()).getFullYear();
    function getMonthName(m) {
      const names = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
      return names[m] || '';
    }

    function generateCalendar() {
      const cal = document.getElementById('calendar');
      if(!cal) return;
      cal.innerHTML = '';
      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const label = document.getElementById('calendarLabel');
      if(label) label.innerText = getMonthName(currentMonth) + ' ' + currentYear;

      // Blank slots for first week
      for(let i=0;i<firstDay;i++){
        const empty = document.createElement('div'); empty.className = 'day'; empty.style.visibility = 'hidden'; cal.appendChild(empty);
      }

      for(let day=1; day<=daysInMonth; day++){
        const dayDiv = document.createElement('div'); dayDiv.className = 'day';
        const dateSpan = document.createElement('div'); dateSpan.className = 'date'; dateSpan.innerText = day;
        dayDiv.appendChild(dateSpan);

        // Load tasks for this day
        const key = UserSystem.getUserKey(`calendar-tasks-${currentYear}-${currentMonth}`);
        const tasks = JSON.parse(localStorage.getItem(key) || '{}');
        if(tasks[day]){
          const taskList = document.createElement('div');
          tasks[day].forEach((task, idx) => {
            const li = document.createElement('div');
            li.style.color = getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#d6336c';
            li.style.borderRadius = '7px';
            li.style.marginBottom = '3px';
            li.style.padding = '2px 6px';
            li.style.display = 'flex';
            li.style.alignItems = 'center';
            li.style.justifyContent = 'space-between';
            li.innerHTML = `<span><span style='font-weight:bold;'>${task.title}</span>` + (task.hour ? ` <span style='font-size:12px;color:#6b7280;'>â° ${task.hour}</span>` : '') + `</span>`;

            const editBtn = document.createElement('button');
            editBtn.innerHTML = 'âœï¸';
            editBtn.title = 'Editar tarea';
            editBtn.style.background = 'none';
            editBtn.style.border = 'none';
            editBtn.style.cursor = 'pointer';
            editBtn.style.fontSize = '16px';
            editBtn.style.marginRight = '6px';
            editBtn.onclick = function(e) { e.stopPropagation(); editCalendarTask(currentYear, currentMonth, day, idx, task); };
            li.appendChild(editBtn);

            const delBtn = document.createElement('button');
            delBtn.innerHTML = 'ğŸ—‘ï¸';
            delBtn.title = 'Eliminar tarea';
            delBtn.style.background = 'none';
            delBtn.style.border = 'none';
            delBtn.style.cursor = 'pointer';
            delBtn.style.fontSize = '16px';
            delBtn.onclick = function(e) { e.stopPropagation(); deleteCalendarTask(currentYear, currentMonth, day, idx); };
            li.appendChild(delBtn);

            taskList.appendChild(li);
          });
          dayDiv.appendChild(taskList);
        }

        dayDiv.onclick = function(e){ e.stopPropagation(); showTaskForm(currentYear, currentMonth, day, dayDiv); };
        cal.appendChild(dayDiv);
      }
    }
    function startPomodoro(){
      if(pomodoroTimer) return;
      isPaused = false;
      document.getElementById('pauseBtn').style.display = 'inline-block';
      document.querySelector('button[onclick="startPomodoro()"]').style.display = 'none';
      
      pomodoroTimer = setInterval(()=>{
        if(pomodoroTimeLeft>0){
          pomodoroTimeLeft--;
          updatePomodoro();
        } else {
          isWorkPhase = !isWorkPhase;
          pomodoroTimeLeft = isWorkPhase ? workDuration : breakDuration;
          updatePomodoro();
          const message = isWorkPhase ? 'Â¡Descanso terminado! A trabajar ğŸ’ª' : 'Â¡Trabajo terminado! Descansa ğŸŒ¸';
          alert(message);
          playNotificationSound();
        }
      },1000);
    }
    
    function pausePomodoro(){
      if(pomodoroTimer) {
        clearInterval(pomodoroTimer);
        pomodoroTimer = null;
        isPaused = true;
        document.getElementById('pauseBtn').innerText = 'Reanudar';
        document.getElementById('pauseBtn').onclick = startPomodoro;
      }
    }
    
    function resetPomodoro(){
      clearInterval(pomodoroTimer);
      pomodoroTimer = null;
      isPaused = false;
      isWorkPhase = true;
      pomodoroTimeLeft = workDuration;
      updatePomodoro();
      document.getElementById('pauseBtn').style.display = 'none';
      document.getElementById('pauseBtn').innerText = 'Pausar';
      document.getElementById('pauseBtn').onclick = pausePomodoro;
      document.querySelector('button[onclick="startPomodoro()"]').style.display = 'inline-block';
    }
          
// Editar tarea del calendario
function editCalendarTask(year, month, dayNum, taskIdx, task) {
  if(document.getElementById('calendarTaskForm')) return;
  const form = document.createElement('div');
  form.id = 'calendarTaskForm';
  form.style.position = 'fixed';
  form.style.left = '50%';
  form.style.top = '50%';
  form.style.transform = 'translate(-50%,-50%)';
  form.style.background = '#fff6fb';
  form.style.border = '2px solid #d6336c';
  form.style.boxShadow = '0 6px 18px #d6336c22';
  form.style.padding = '22px 18px 18px 18px';
  form.style.zIndex = 1000;
  form.innerHTML = `
    <div style='font-weight:bold;color:#d6336c;font-size:18px;margin-bottom:10px;'>Editar tarea para el ${dayNum} de ${getMonthName(month)} ${year}</div>
    <input id='taskTitleInput' type='text' placeholder='TÃ­tulo de la tarea' value="${task.title.replace(/"/g, '&quot;')}" style='width:100%;margin-bottom:8px;padding:7px;border-radius:8px;border:1px solid #e6e6e6;'>
    <input id='taskHourInput' type='time' value="${task.hour || ''}" style='width:100%;margin-bottom:8px;padding:7px;border-radius:8px;border:1px solid #e6e6e6;'>
    <div style='margin-bottom:8px;'>
      <label style='font-size:12px;font-weight:600;color:#666;display:block;margin-bottom:6px;'>Minutos antes (0 = sin alarma)</label>
      <input id='taskAlarmInput' type='number' min='0' max='1440' value="${task.alarm || 0}" style='width:100%;margin-bottom:8px;padding:7px;border-radius:8px;border:1px solid #e6e6e6;'>
    </div>
    <div style='display:flex;gap:8px;align-items:center;margin-bottom:8px;'>
      <select id='taskSoundInput' style='flex:1;padding:7px;border-radius:8px;border:1px solid #e6e6e6;'>
        <option value='none' ${task.sound==='none'?'selected':''}>ğŸ”• Sin timbre</option>
        <option value='bell' ${task.sound==='bell'?'selected':''}>ğŸ”” Campana</option>
        <option value='ding' ${task.sound==='ding'?'selected':''}>ğŸµ Timbre</option>
        <option value='soft' ${task.sound==='soft'?'selected':''}>ğŸŒ¸ MelodÃ­a suave</option>
      </select>
      <button id='testSoundBtnEdit' style='white-space:nowrap;padding:7px 10px;border-radius:8px;border:1px solid #e6e6e6;background:#fff;cursor:pointer;'>ğŸ”” Probar</button>
    </div>
    <div style='font-size:13px;color:#6b7280;margin-bottom:10px;'>La hora de entrega, la alarma y el sonido son opcionales</div>
    <button id='saveEditTaskBtn' class='btn-primary' style='width:100%;margin-bottom:6px;'>Guardar cambios</button>
    <button id='cancelEditTaskBtn' class='btn-muted' style='width:100%;'>Cancelar</button>
  `;
  document.body.appendChild(form);
  document.getElementById('taskTitleInput').focus();
  // asignar handler al botÃ³n de prueba del formulario de editar
  const testEdit = document.getElementById('testSoundBtnEdit');
  if(testEdit){
    testEdit.onclick = function(e){ e.stopPropagation(); const s = document.getElementById('taskSoundInput').value; if(s === 'none'){ alert('Sin timbre seleccionado'); return; } playAlarmSound(s); };
  }
  document.getElementById('cancelEditTaskBtn').onclick = function() {
    form.remove();
  };
  document.getElementById('saveEditTaskBtn').onclick = function() {
    const title = document.getElementById('taskTitleInput').value.trim();
    const hour = document.getElementById('taskHourInput').value;
    const alarm = parseInt(document.getElementById('taskAlarmInput').value);
    const sound = document.getElementById('taskSoundInput').value;
    if(!title) { alert('Por favor, escribe un tÃ­tulo para la tarea.'); return; }
    const key = UserSystem.getUserKey(`calendar-tasks-${year}-${month}`);
    let tasks = JSON.parse(localStorage.getItem(key) || '{}');
    if(tasks[dayNum] && tasks[dayNum][taskIdx]) {
      tasks[dayNum][taskIdx] = {title, hour, alarm, sound};
      localStorage.setItem(key, JSON.stringify(tasks));
      form.remove();
      generateCalendar();
    }
  };
}
// Eliminar tarea del calendario
function deleteCalendarTask(year, month, dayNum, taskIdx) {
  const key = UserSystem.getUserKey(`calendar-tasks-${year}-${month}`);
  let tasks = JSON.parse(localStorage.getItem(key) || '{}');
  if(tasks[dayNum]) {
    tasks[dayNum].splice(taskIdx, 1);
    if(tasks[dayNum].length === 0) {
      delete tasks[dayNum];
    }
    localStorage.setItem(key, JSON.stringify(tasks));
    generateCalendar();
  }
}
    
// Formulario flotante para agregar tarea a un dÃ­a
function showTaskForm(year, month, dayNum, dayElem) {
      // Evitar mÃºltiples formularios
      if(document.getElementById('calendarTaskForm')) return;
      const form = document.createElement('div');
      form.id = 'calendarTaskForm';
      form.style.position = 'fixed';
      form.style.left = '50%';
      form.style.top = '50%';
      form.style.transform = 'translate(-50%,-50%)';
      form.style.background = '#fff6fb';
      form.style.border = '2px solid #d6336c';
      form.style.boxShadow = '0 6px 18px #d6336c22';
      form.style.padding = '22px 18px 18px 18px';
      form.style.zIndex = 1000;
      form.innerHTML = `
        <div style='font-weight:bold;color:#d6336c;font-size:18px;margin-bottom:10px;'>Agregar tarea para el ${dayNum} de ${getMonthName(month)} ${year}</div>
        <input id='taskTitleInput' type='text' placeholder='TÃ­tulo de la tarea' style='width:100%;margin-bottom:8px;padding:7px;border-radius:8px;border:1px solid #e6e6e6;'>
        <input id='taskHourInput' type='time' style='width:100%;margin-bottom:8px;padding:7px;border-radius:8px;border:1px solid #e6e6e6;'>
        <div style='margin-bottom:8px;'>
          <label style='font-size:12px;font-weight:600;color:#666;display:block;margin-bottom:6px;'>Minutos antes (0 = sin alarma)</label>
          <input id='taskAlarmInput' type='number' min='0' max='1440' value='10' style='width:100%;margin-bottom:8px;padding:7px;border-radius:8px;border:1px solid #e6e6e6;'>
        </div>
        <div style='display:flex;gap:8px;align-items:center;margin-bottom:8px;'>
          <select id='taskSoundInput' style='flex:1;padding:7px;border-radius:8px;border:1px solid #e6e6e6;'>
            <option value='none'>ğŸ”• Sin timbre</option>
            <option value='bell'>ğŸ”” Campana</option>
            <option value='ding'>ğŸµ Timbre</option>
            <option value='soft'>ğŸŒ¸ MelodÃ­a suave</option>
          </select>
          <button id='testSoundBtnAdd' style='white-space:nowrap;padding:7px 10px;border-radius:8px;border:1px solid #e6e6e6;background:#fff;cursor:pointer;'>ğŸ”” Probar</button>
        </div>
        <div style='font-size:13px;color:#6b7280;margin-bottom:10px;'>La hora de entrega, la alarma y el sonido son opcionales</div>
        <button id='saveTaskBtn' class='btn-primary' style='width:100%;margin-bottom:6px;'>Guardar tarea</button>
        <button id='cancelTaskBtn' class='btn-muted' style='width:100%;'>Cancelar</button>
      `;
      document.body.appendChild(form);
      document.getElementById('taskTitleInput').focus();
      // asignar handler al botÃ³n de prueba del formulario de aÃ±adir
      const testAdd = document.getElementById('testSoundBtnAdd');
      if(testAdd){
        testAdd.onclick = function(e){ e.stopPropagation(); const s = document.getElementById('taskSoundInput').value; if(s === 'none'){ alert('Sin timbre seleccionado'); return; } playAlarmSound(s); };
      }
      document.getElementById('cancelTaskBtn').onclick = function() {
        form.remove();
      };
      document.getElementById('saveTaskBtn').onclick = function() {
        const title = document.getElementById('taskTitleInput').value.trim();
        const hour = document.getElementById('taskHourInput').value;
        const alarm = parseInt(document.getElementById('taskAlarmInput').value);
        const sound = document.getElementById('taskSoundInput').value;
        if(!title) { alert('Por favor, escribe un tÃ­tulo para la tarea.'); return; }
        saveCalendarTask(year, month, dayNum, title, hour, alarm, sound);
        form.remove();
        generateCalendar();
      };
    }

// Guardar tarea en localStorage
function saveCalendarTask(year, month, dayNum, title, hour, alarm, sound) {
  const key = UserSystem.getUserKey(`calendar-tasks-${year}-${month}`);
  let tasks = JSON.parse(localStorage.getItem(key) || '{}');
  if(!tasks[dayNum]) tasks[dayNum] = [];
  tasks[dayNum].push({title, hour, alarm, sound});
  localStorage.setItem(key, JSON.stringify(tasks));
}

// Sonidos de alarma (URLs) â€” creamos un nuevo Audio al reproducir para asegurar variaciones
const alarmSounds = {
  bell: 'https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae3b2.mp3', // Campana
  ding: 'https://cdn.pixabay.com/audio/2022/03/15/audio_115b9b7b7b.mp3', // Timbre
  soft: 'https://cdn.pixabay.com/audio/2022/10/16/audio_12b6b7b7b7.mp3' // MelodÃ­a suave
};

// Reproducir sonido de alarma con fallback a WebAudio (evitar reusar mismo objeto y asegurar sonido correcto)
function playAlarmSound(type){
  // si el usuario seleccionÃ³ 'Sin timbre', no reproducir
  if(type === 'none') return;
  try{
    const url = alarmSounds[type] || alarmSounds.bell;
    if(url){
      const a = new Audio(url);
      a.currentTime = 0;
      const p = a.play();
      if(p && p.catch){
        p.catch(()=>{ playNotificationSound(); });
      }
      return;
    }
  }catch(e){ }
  // Fallback: tono corto usando WebAudio
  playNotificationSound();
}

// Chequear tareas con alarma y reproducir cuando corresponda
function checkTaskAlarms(){
  const user = UserSystem.getCurrentUser();
  if(!user) return;
  const prefix = `user_${user}_calendar-tasks-`;
  const now = Date.now();
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(!k || !k.startsWith(prefix)) continue;
    const suffix = k.slice(prefix.length); // e.g. '2025-10'
    const parts = suffix.split('-');
    if(parts.length < 2) continue;
    const year = parseInt(parts[0]);
    const month = parseInt(parts[1]);
    let tasksByDay = {};
    try{ tasksByDay = JSON.parse(localStorage.getItem(k) || '{}'); }catch(e){ continue; }
    Object.keys(tasksByDay).forEach(dayKey => {
      const dayNum = parseInt(dayKey);
      const list = tasksByDay[dayKey] || [];
      list.forEach((task, idx)=>{
        if(!task || !task.hour) return;
        const alarmMins = parseInt(task.alarm || 0);
        if(!alarmMins) return;
        const hourParts = (''+task.hour).split(':');
        if(hourParts.length<2) return;
        const hh = parseInt(hourParts[0]);
        const mm = parseInt(hourParts[1]);
        const taskTime = new Date(year, month, dayNum, hh, mm).getTime();
        const alarmTime = taskTime - alarmMins*60*1000;
        const firedKey = UserSystem.getUserKey(`alarm_fired_${year}_${month}_${dayNum}_${idx}`);
        if(localStorage.getItem(firedKey)) return; // already played
        // if current time is within 60s window after alarmTime, trigger
        if(now >= alarmTime && now < alarmTime + 60*1000){
          // play sound (task.sound may be set)
          playAlarmSound(task.sound || 'bell');
          try{ localStorage.setItem(firedKey, '1'); }catch(e){}
        }
      });
    });
  }
}

function initTaskAlarms(){
  // run now and then every 30s
  try{ checkTaskAlarms(); }catch(e){}
  setInterval(()=>{ try{ checkTaskAlarms(); }catch(e){} }, 30*1000);
}


document.getElementById('prevMonth').onclick = function() {
  currentMonth--;
  if(currentMonth<0){currentMonth=11;currentYear--;}
  generateCalendar();
};
document.getElementById('nextMonth').onclick = function() {
  currentMonth++;
  if(currentMonth>11){currentMonth=0;currentYear++;}
  generateCalendar();
};
document.getElementById('prevYear').onclick = function() {
  currentYear--;
  generateCalendar();
};
document.getElementById('nextYear').onclick = function() {
  currentYear++;
  generateCalendar();
};

// Estilo floral para los botones de navegaciÃ³n
const styleFlower = document.createElement('style');
styleFlower.innerHTML = `.btn-flower-nav { background: #fff6fb; color: #d6336c; border: 1.5px solid #d6336c; border-radius: 50%; padding: 7px 13px; font-size: 20px; margin: 0 2px; cursor: pointer; transition: background 0.2s; box-shadow: 0 2px 8px #d6336c22; } .btn-flower-nav:hover { background: #ffe3ef; }`;
document.head.appendChild(styleFlower);

generateCalendar();
</script>
</body>
</html>
